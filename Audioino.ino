#define cbi(sfr, bit) (_SFR_BYTE(sfr) &= ~_BV(bit))
#define sbi(sfr, bit) (_SFR_BYTE(sfr) |= _BV(bit))
#define BUFFER_LENGTH 512

const int analogOutPin = 6;

int signal = 0; 
//int delayBuffer[BUFFER_LENGTH];
int index = 0;
int sineWave[BUFFER_LENGTH] = {126,128,129,131,132,134,135,137,138,140,141,143,144,146,147,149,150,152,153,155,156,158,159,161,162,164,165,167,168,170,171,173,174,175,177,178,180,181,182,184,185,186,188,189,190,192,193,194,196,197,198,199,201,202,203,204,205,207,208,209,210,211,212,213,215,216,217,218,219,220,221,222,223,224,225,226,227,227,228,229,230,231,232,233,233,234,235,236,236,237,238,238,239,240,240,241,242,242,243,243,244,244,245,245,246,246,247,247,247,248,248,248,249,249,249,249,250,250,250,250,250,251,251,251,251,251,251,251,251,251,251,251,251,251,251,251,250,250,250,250,250,249,249,249,249,248,248,248,247,247,246,246,245,245,245,244,244,243,242,242,241,241,240,239,239,238,237,237,236,235,235,234,233,232,231,230,230,229,228,227,226,225,224,223,222,221,220,219,218,217,216,215,214,213,212,211,210,208,207,206,205,204,202,201,200,199,197,196,195,194,192,191,190,188,187,186,184,183,182,180,179,177,176,175,173,172,170,169,167,166,165,163,162,160,159,157,156,154,153,151,150,148,147,145,144,142,141,139,138,136,134,133,131,130,128,127,125,124,122,121,119,118,116,114,113,111,110,108,107,105,104,102,101,99,98,96,95,93,92,90,89,87,86,85,83,82,80,79,77,76,75,73,72,70,69,68,66,65,64,62,61,60,58,57,56,55,53,52,51,50,48,47,46,45,44,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,22,21,20,19,18,17,17,16,15,15,14,13,13,12,11,11,10,10,9,8,8,7,7,7,6,6,5,5,4,4,4,3,3,3,3,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,3,3,3,3,4,4,4,5,5,5,6,6,7,7,8,8,9,9,10,10,11,12,12,13,14,14,15,16,16,17,18,19,19,20,21,22,23,24,25,25,26,27,28,29,30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,47,48,49,50,51,53,54,55,56,58,59,60,62,63,64,66,67,68,70,71,72,74,75,77,78,79,81,82,84,85,87,88,90,91,93,94,96,97,99,100,102,103,105,106,108,109,111,112,114,115,117,118,120,121,123,124,126};

void setup() {  
  //Set ADC parameters
  ADCSRA = 0;
  cbi(ADCSRA, ADPS2);
  sbi(ADCSRA, ADPS1);
  cbi(ADCSRA, ADPS0);
  
  sbi(ADCSRA, ADATE);
  sbi(ADCSRA, ADEN);
  sbi(ADCSRA, ADSC);
  
  sbi(ADMUX, REFS0);
  sbi(ADMUX, ADLAR);

  //Set pins 5 and 6 to Fast PWM at 62.5 kHz
  TCCR0B = 0;
  sbi(TCCR0B, CS00);
  sbi(TCCR0A, COM0A1);
  sbi(TCCR0A, COM0B1); 
  sbi(TCCR0A, WGM01); 
  sbi(TCCR0A, WGM00); 
  
  //memset(delayBuffer, 0, sizeof(delayBuffer));
}

void loop() {
  //ADCH reads from A0
  //signal = ADCH;
  signal = playSine(20);
  analogWrite(analogOutPin, signal);
}

int playSine(int frequency) {
  int output = sineWave[index];
  index = (index + frequency) % BUFFER_LENGTH;
  return output;
}

//int delaySignal(int input) {
//  int output = 0;
//  
//  delayBuffer[index] = input;
//  
//  int delayIndex = index - 510;
//  if (delayIndex < 0) {
//    delayIndex += BUFFER_LENGTH;
//  }
//  
//  output = (2 * delayBuffer[delayIndex] + 3 * signal) / 5;
//  index = (index + 1) % BUFFER_LENGTH;
//  return output;
//}
